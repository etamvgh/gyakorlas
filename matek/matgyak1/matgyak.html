<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matekkvíz 0–20</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      font-family: Arial, sans-serif;
      align-items: center;
    }

    body.shake {
      animation: shake 0.4s;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(6px); }
      75% { transform: translateX(-6px); }
      100% { transform: translateX(0); }
    }

    #controls {
      width: 100%;
      max-width: 600px;
      padding: 10px 20px;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    /* Egy sorban: statisztika | checkboxok | új feladat gomb */
    #control-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      flex-wrap: wrap;
      gap: 8px;
    }
    #new-btn {
      padding: 8px 16px;
      font-size: 16px;
    }
    #stats {
      font-size: 16px;
      white-space: nowrap;
    }
    .highlight {
      transition: transform 0.4s ease, color 0.4s ease;
      display: inline-block;
    }
    .highlight.animated-up {
      transform: scale(3.6);
      font-weight: bold;
      color: #4caf50;
    }
    .highlight.animated-down {
      transform: scale(3.6);
      font-weight: normal;
      color: #f44336;
      background-color:pink;
      box-shadow:0px 0px 12px 12px pink;
    }
    #score-bar-container,
    #timer-bar-container {
      width: 100%;
      height: 6px;
      background: #ddd;
      overflow: hidden;
      position: relative;
    }
    #score-bar {
      height: 100%;
      background: #4caf50;
      width: 0%;
      transition: width 0.2s;
    }
    #timer-bar {
      height: 100%;
      background: #66aaff;
      transition: width linear;
      width: 100%;
    }

    .container {
      flex: 1;
      width: 100%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
    }

    .left-side {
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 32px;
      font-weight: bold;
    }
    .left-side .box {
      width: 80px;
      height: 80px;
      border: 3px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .left-side .op,
    .left-side .eq {
      user-select: none;
    }

    .right-side {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      padding: 20px;
      width: 100%;
      justify-items: center;
    }
    .right-side .box {
      width: 60px;
      height: 60px;
      border: 2px solid #666;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      user-select: none;
    }
    .right-side .box:not(.disabled):hover {
      background-color: #e0f0ff;
      border-color: #66aaff;
    }
    .right-side .box.disabled {
      pointer-events: none;
    }

    .box.correct {
      background-color: #c8e6c9;
      border-color: #256029;
      color: #256029;
    }
    .box.wrong {
      background-color: #ffcdd2;
      border-color: #a12828;
      color: #a12828;
    }

    /* Checkboxok stílusa */
    #ops {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
      user-select: none;
    }
    #ops label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    #ops input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Visszajelző kép */
    #feedback-img {
      display: none;
      width: 320px;
      height: auto;
      margin: 10px 0;
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="controls">
    <div id="control-row">
      <div id="stats">
        Találatok: <span id="hits">0 / 0</span> |
        Pontok: <span id="score" class="highlight">0</span> |
        Szint: <span id="level" class="highlight">1</span>
      </div>
      <div id="ops" aria-label="Műveletek kiválasztása">
        <label><input type="checkbox" id="add-cb" checked /> +</label>
        <label><input type="checkbox" id="sub-cb" checked /> −</label>
      </div>
      <!-- Kezdetben NEM letiltva, hogy rögtön lehessen indítani -->
      <button id="new-btn">Új feladat</button>
    </div>
    <div id="score-bar-container">
      <div id="score-bar"></div>
    </div>
    <div id="timer-bar-container">
      <div id="timer-bar"></div>
    </div>
  </div>

  <div class="container">
    <div class="left-side" id="left-side"></div>
    <div class="right-side" id="right-side"></div>
    <!-- Visszajelző kép -->
    <img id="feedback-img" src="" alt="" onerror="this.style.display='none'" />
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    let correctCount = 0;
    let totalCount = 0;
    let score = 0;
    let level = 1;
    let timerId = null;
    const timerBar = document.getElementById('timer-bar');
    const scoreBar = document.getElementById('score-bar');
    const scoreEl = document.getElementById('score');
    const levelEl = document.getElementById('level');
    const hitsEl = document.getElementById('hits');
    const addCb = document.getElementById('add-cb');
    const subCb = document.getElementById('sub-cb');
    const feedbackImg = document.getElementById('feedback-img');
    const newBtn = document.getElementById('new-btn');

    /**
     * Biztonsági kérdés oldal bezárása / frissítése előtt
     */
    window.addEventListener('beforeunload', e => {
      e.preventDefault();
      e.returnValue = '';
    });

    /** Időkorlát szintenként (ms) */
    function getTimeLimit(level) {
      return Math.max(5000, 20000 - (level - 1) * 2000);
    }

    function updateScoreBar() {
      const percent = (score / 10) * 100;
      scoreBar.style.width = percent + '%';
    }

    /** Engedélyezett műveletek listája */
    function getAllowedOps() {
      const ops = [];
      if (addCb.checked) ops.push('+');
      if (subCb.checked) ops.push('-');
      return ops;
    }

    /** Véletlen feladat generálása */
    function generateProblem() {
      const allowed = getAllowedOps();
      if (allowed.length === 0) allowed.push('+');
      const op = allowed[Math.floor(Math.random() * allowed.length)];

      let a, b, result;
      if (op === '+') {
        result = Math.floor(Math.random() * 21);
        a = Math.floor(Math.random() * (result + 1));
        b = result - a;
      } else {
        a = Math.floor(Math.random() * 21);
        b = Math.floor(Math.random() * (a + 1));
        result = a - b;
      }
      return { a, b, op, result };
    }

    function createBox(content, extraClass = '') {
      const div = document.createElement('div');
      div.className = 'box' + (extraClass ? ' ' + extraClass : '');
      div.textContent = content;
      return div;
    }

    function render() {
      clearTimeout(timerId);
      const timeLimit = getTimeLimit(level);

      // Visszaszámláló reset
      timerBar.style.transition = 'none';
      timerBar.style.width = '100%';
      void timerBar.offsetWidth;
      timerBar.style.transition = `width ${timeLimit}ms linear`;
      timerBar.style.width = '0%';

      // Visszajelző kép elrejtése
      feedbackImg.style.display = 'none';

      newBtn.disabled = true;

      const { a, b, op, result } = generateProblem();

      const left = document.getElementById('left-side');
      left.innerHTML = '';
      left.appendChild(createBox(a));
      left.appendChild(Object.assign(document.createElement('div'), { className: 'op', textContent: op }));
      left.appendChild(createBox(b));
      left.appendChild(Object.assign(document.createElement('div'), { className: 'eq', textContent: '=' }));
      const resultBox = createBox('?', 'result-box');
      resultBox.id = 'result-box';
      left.appendChild(resultBox);

      const right = document.getElementById('right-side');
      right.innerHTML = '';
      for (let i = 0; i <= 20; i++) {
        const box = createBox(i);
        box.addEventListener('click', () => {
          clearTimeout(timerId);
          stopTimerBar();
          handleClick(i, result);
        });
        right.appendChild(box);
      }

      timerId = setTimeout(() => {
        stopTimerBar();
        handleClick(null, result);
      }, timeLimit);
    }

    function stopTimerBar() {
      const computedStyle = window.getComputedStyle(timerBar);
      timerBar.style.transition = 'none';
      timerBar.style.width = computedStyle.width;
    }

    function animateValue(el, direction) {
      const cls = direction > 0 ? 'animated-up' : 'animated-down';
      el.classList.add(cls);
      setTimeout(() => el.classList.remove(cls), 400);
    }

    function shakeScreen() {
      document.body.classList.add('shake');
      setTimeout(() => document.body.classList.remove('shake'), 400);
    }

    function handleClick(choice, correct) {
      const disabledAlready = document.querySelector('.right-side .box.disabled');
      if (disabledAlready) return;

      const resultBox = document.getElementById('result-box');
      const prevScore = score;
      const prevLevel = level;

      totalCount++;
      let levelUp = false;

      const isCorrect = choice === correct;

      if (isCorrect) {
        correctCount++;
        score++;
      } else {
        score = Math.max(0, score - 2);
        shakeScreen();
      }

      if (score >= 10) {
        level++;
        score = 0;
        levelUp = true;
      }

      updateScoreBar();

      document.querySelectorAll('.right-side .box').forEach(b => {
        b.classList.add('disabled');
        const val = +b.textContent;
        if (val === correct) b.classList.add('correct');
        else if (val === choice) b.classList.add('wrong');
      });

      // Kép index 0–9
      const idx = Math.floor(Math.random() * 10);
      feedbackImg.src = isCorrect ? `assets/happy${idx}.png` : `assets/sad${idx}.png`;
      //feedbackImg.alt = isCorrect ? 'Jó válasz' : 'Rossz válasz';
      feedbackImg.style.display = 'block';

      if (resultBox) resultBox.textContent = correct;
      newBtn.disabled = false;

      hitsEl.textContent = `${correctCount} / ${totalCount}`;
      if (score !== prevScore) animateValue(scoreEl, score - prevScore);
      if (level !== prevLevel) animateValue(levelEl, level - prevLevel);
      scoreEl.textContent = score;
      levelEl.textContent = level;

      if (levelUp) confetti();
    }

    newBtn.addEventListener('click', render);

    // Szóköz a feladat indításához, ha a gomb épp engedélyezve van
    document.addEventListener('keydown', e => {
      if (e.code === 'Space' && !newBtn.disabled) {
        e.preventDefault();
        newBtn.click();
      }
    });

    /** Legalább egy checkbox maradjon bekapcsolva */
    function enforceAtLeastOne(e) {
      if (!addCb.checked && !subCb.checked) {
        e.target.checked = true;
        return;
      }
      // Csak akkor frissítjük a futó feladatot, ha van aktív (gomb letiltva)
      if (newBtn.disabled) render();
    }

    addCb.addEventListener('change', enforceAtLeastOne);
    subCb.addEventListener('change', enforceAtLeastOne);
  </script>
</body>
</html>
